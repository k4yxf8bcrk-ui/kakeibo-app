<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>å®¶è¨ˆç°¿ & æ¯æœˆã®å›ºå®šè²» ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- â˜… æœˆã”ã¨ã®ã‚°ãƒ©ãƒ•ç”¨ï¼šChart.js èª­ã¿è¾¼ã¿ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f6fb;
    }
    header {
      background: #2563eb;
      color: white;
      padding: 12px 16px;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
    }
    main {
      padding: 12px 16px 40px;
      max-width: 900px;
      margin: 0 auto;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 14px 16px 16px;
      margin-bottom: 16px;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.08);
    }
    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card-subtitle {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 8px;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }
    .summary-item {
      background: #eff6ff;
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px;
    }
    .summary-label {
      color: #64748b;
      margin-bottom: 4px;
    }
    .summary-value {
      font-weight: 700;
      font-size: 14px;
    }
    @media (min-width: 720px) {
      .summary-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }
    .form-group {
      flex: 1;
      min-width: 120px;
      display: flex;
      flex-direction: column;
      font-size: 12px;
    }
    label {
      margin-bottom: 4px;
      color: #475569;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="month"],
    select {
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      padding: 6px 8px;
      font-size: 13px;
      outline: none;
      box-sizing: border-box;
    }
    input:focus,
    select:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
    }
    .radio-row {
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 13px;
    }
    .btn-primary {
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    .btn-primary:active {
      transform: translateY(1px);
    }
    .btn-danger {
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
    }
    .btn-secondary {
      background: #e2e8f0;
      color: #0f172a;
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      margin-left: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 12px;
    }
    th, td {
      padding: 6px 4px;
      border-bottom: 1px solid #e2e8f0;
      text-align: left;
      white-space: nowrap;
    }
    th {
      font-weight: 600;
      font-size: 11px;
      color: #64748b;
    }
    td.amount {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .chip {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #e5f3ff;
      color: #1d4ed8;
    }
    .chip-expense {
      background: #fee2e2;
      color: #b91c1c;
    }
    .chip-income {
      background: #dcfce7;
      color: #166534;
    }
    .text-right {
      text-align: right;
    }
    .text-muted {
      color: #9ca3af;
    }
    .highlight {
      font-weight: 700;
      color: #0f172a;
    }

    /* â˜… ã‚°ãƒ©ãƒ•ç”¨ã‚³ãƒ³ãƒ†ãƒŠ */
    .chart-wrapper {
      position: relative;
      width: 100%;
      height: 260px;
      margin-top: 8px;
    }
    @media (min-width: 720px) {
      .chart-wrapper {
        height: 280px;
      }
    }
  </style>
</head>
<body>
  <header>å®¶è¨ˆç°¿ & æ¯æœˆã®å›ºå®šè²» ç®¡ç†</header>
  <main>
    <!-- æœˆã®ã‚µãƒãƒªãƒ¼ -->
    <section class="card">
      <div class="card-title">
        <span>ä»Šæœˆã®ã‚µãƒãƒªãƒ¼</span>
        <div>
          <label for="monthFilter" style="font-size:11px; margin-right:4px; color:#e5e7eb;">æœˆã‚’é¸æŠ</label>
          <input type="month" id="monthFilter" />
        </div>
      </div>
      <div class="card-subtitle">
        åå…¥ãƒ»æ”¯å‡ºãƒ»å›ºå®šè²»ãƒ»æ®‹é‡‘ã‚’ã–ã£ãã‚Šãƒã‚§ãƒƒã‚¯ã§ãã¾ã™ã€‚
      </div>
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-label">åå…¥åˆè¨ˆ</div>
          <div class="summary-value" id="summaryIncome">Â¥0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">å¤‰å‹•æ”¯å‡ºåˆè¨ˆ</div>
          <div class="summary-value" id="summaryExpense">Â¥0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">å›ºå®šè²»åˆè¨ˆï¼ˆç™»éŒ²åˆ†ï¼‰</div>
          <div class="summary-value" id="summaryFixed">Â¥0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">æ®‹ã‚Šï¼ˆåå…¥ âˆ’ å¤‰å‹• âˆ’ å›ºå®šï¼‰</div>
          <div class="summary-value" id="summaryBalance">Â¥0</div>
        </div>
      </div>
    </section>

    <!-- â˜… æœˆã”ã¨ã®æ¨ç§»ã‚°ãƒ©ãƒ• -->
    <section class="card">
      <div class="card-title">
        <span>ğŸ“Š æœˆã”ã¨ã®æ¨ç§»ã‚°ãƒ©ãƒ•</span>
      </div>
      <div class="card-subtitle">
        æœˆã”ã¨ã®ã€Œåå…¥ã€ã€Œæ”¯å‡ºã€ã€Œæ®‹ã‚Šã€ã‚’ã‚°ãƒ©ãƒ•ã§ç¢ºèªã§ãã¾ã™ã€‚å›ºå®šè²»ã¯æ¯æœˆåŒã˜é¡ã¨ã—ã¦å¼•ã„ã¦ã„ã¾ã™ã€‚
      </div>
      <div class="chart-wrapper">
        <canvas id="monthlyTrendChart"></canvas>
      </div>
      <div class="card-subtitle" style="margin-top:8px; font-size:11px;">
        â€» æ®‹ã‚Š ï¼ åå…¥ âˆ’ æ”¯å‡º âˆ’ å›ºå®šè²»åˆè¨ˆï¼ˆç™»éŒ²ã—ã¦ã„ã‚‹å›ºå®šè²»ï¼‰  
        â€» å®¶è¨ˆç°¿ã‚„å›ºå®šè²»ã‚’è¿½åŠ ãƒ»å‰Šé™¤ã™ã‚‹ã¨è‡ªå‹•ã§æ›´æ–°ã•ã‚Œã¾ã™ã€‚
      </div>
    </section>

    <!-- å®¶è¨ˆç°¿å…¥åŠ› -->
    <section class="card">
      <div class="card-title">
        <span>å®¶è¨ˆç°¿ï¼ˆåå…¥ãƒ»æ”¯å‡ºï¼‰</span>
      </div>
      <div class="card-subtitle">
        ãã®éƒ½åº¦ã€æ—¥ä»˜ã¨é‡‘é¡ã‚’å…¥ã‚Œã¦ã€Œè¿½åŠ ã€ã™ã‚‹ã ã‘ã€‚ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
      </div>

      <form id="kakeiboForm">
        <div class="form-row">
          <div class="form-group" style="max-width: 140px;">
            <label for="kakeiboDate">æ—¥ä»˜</label>
            <input type="date" id="kakeiboDate" required />
          </div>

          <div class="form-group" style="max-width: 160px;">
            <label>ç¨®åˆ¥</label>
            <div class="radio-row">
              <label><input type="radio" name="type" value="income" checked /> åå…¥</label>
              <label><input type="radio" name="type" value="expense" /> æ”¯å‡º</label>
            </div>
          </div>

          <div class="form-group">
            <label for="kakeiboCategory">ã‚«ãƒ†ã‚´ãƒª</label>
            <select id="kakeiboCategory">
              <option value="æœªåˆ†é¡">æœªåˆ†é¡</option>
              <option value="é£Ÿè²»">é£Ÿè²»</option>
              <option value="æ—¥ç”¨å“">æ—¥ç”¨å“</option>
              <option value="äº¤é€š">äº¤é€š</option>
              <option value="å¨¯æ¥½">å¨¯æ¥½</option>
              <option value="å…‰ç†±è²»">å…‰ç†±è²»</option>
              <option value="å®¶è³ƒ">å®¶è³ƒ</option>
              <option value="é€šä¿¡">é€šä¿¡</option>
              <option value="çµ¦æ–™">çµ¦æ–™</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
          </div>

          <div class="form-group">
            <label for="kakeiboAmount">é‡‘é¡ï¼ˆå††ï¼‰</label>
            <input type="number" id="kakeiboAmount" min="0" required />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group" style="flex:2;">
            <label for="kakeiboMemo">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
            <input type="text" id="kakeiboMemo" placeholder="ä¾‹ï¼šã‚¹ãƒ¼ãƒ‘ãƒ¼ / çµ¦æ–™æ—¥ ãªã©" />
          </div>
          <div class="form-group" style="flex:0 0 auto; justify-content:flex-end; align-items:flex-end;">
            <button type="submit" class="btn-primary">ï¼‹ è¿½åŠ </button>
          </div>
        </div>
      </form>

      <table id="kakeiboTable">
        <thead>
          <tr>
            <th>æ—¥ä»˜</th>
            <th>ç¨®åˆ¥</th>
            <th>ã‚«ãƒ†ã‚´ãƒª</th>
            <th class="text-right">é‡‘é¡</th>
            <th>ãƒ¡ãƒ¢</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <!-- JSã§æŒ¿å…¥ -->
        </tbody>
      </table>
    </section>

    <!-- æ¯æœˆã®å›ºå®šè²» -->
    <section class="card">
      <div class="card-title">
        <span>æ¯æœˆã®å›ºå®šè²»</span>
      </div>
      <div class="card-subtitle">
        å®¶è³ƒãƒ»ã‚µãƒ–ã‚¹ã‚¯ãƒ»ä¿é™ºãªã©ã€æ¯æœˆã»ã¼å›ºå®šã§ã‹ã‹ã‚‹ã‚‚ã®ã‚’ç™»éŒ²ã—ã¦ãŠãã¾ã™ã€‚
      </div>

      <form id="fixedForm">
        <div class="form-row">
          <div class="form-group">
            <label for="fixedName">åå‰</label>
            <input type="text" id="fixedName" placeholder="ä¾‹ï¼šå®¶è³ƒ / Netflix / ä¿é™º" required />
          </div>
          <div class="form-group">
            <label for="fixedCategory">ã‚«ãƒ†ã‚´ãƒª</label>
            <select id="fixedCategory">
              <option value="å®¶è³ƒ">å®¶è³ƒ</option>
              <option value="é›»æ°—">é›»æ°—</option>
              <option value="ã‚¬ã‚¹">ã‚¬ã‚¹</option>
              <option value="æ°´é“">æ°´é“</option>
              <option value="é€šä¿¡">é€šä¿¡</option>
              <option value="ä¿é™º">ä¿é™º</option>
              <option value="ã‚µãƒ–ã‚¹ã‚¯">ã‚µãƒ–ã‚¹ã‚¯</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
          </div>
          <div class="form-group" style="max-width: 140px;">
            <label for="fixedAmount">é‡‘é¡ï¼ˆå††ï¼‰</label>
            <input type="number" id="fixedAmount" min="0" required />
          </div>
          <div class="form-group" style="max-width: 120px;">
            <label for="fixedDay">å¼•è½ã—æ—¥</label>
            <input type="number" id="fixedDay" min="1" max="31" placeholder="1ã€œ31" />
          </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:4px;">
          <button type="submit" class="btn-primary">ï¼‹ å›ºå®šè²»ã‚’è¿½åŠ </button>
          <button type="button" class="btn-secondary" id="resetAllBtn">
            ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆï¼ˆæ³¨æ„ï¼‰
          </button>
        </div>
      </form>

      <table id="fixedTable">
        <thead>
          <tr>
            <th>åå‰</th>
            <th>ã‚«ãƒ†ã‚´ãƒª</th>
            <th class="text-right">é‡‘é¡</th>
            <th>å¼•è½ã—æ—¥</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <!-- JSã§æŒ¿å…¥ -->
        </tbody>
      </table>
    </section>
  </main>

  <script>
    // ===== ãƒ‡ãƒ¼ã‚¿ä¿å­˜ç”¨ã‚­ãƒ¼ =====
    const STORAGE_KEYS = {
      KAKEIBO: "kakeiboRecords_v1",
      FIXED: "fixedMonthly_v1",
    };

    // ===== çŠ¶æ…‹ç®¡ç† =====
    let kakeiboRecords = [];
    let fixedMonthly = [];
    let monthlyChart = null; // â˜… ã‚°ãƒ©ãƒ•ç”¨

    // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
    function loadData() {
      try {
        const kData = localStorage.getItem(STORAGE_KEYS.KAKEIBO);
        const fData = localStorage.getItem(STORAGE_KEYS.FIXED);
        kakeiboRecords = kData ? JSON.parse(kData) : [];
        fixedMonthly = fData ? JSON.parse(fData) : [];
      } catch (e) {
        console.error("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼", e);
        kakeiboRecords = [];
        fixedMonthly = [];
      }
    }

    function saveData() {
      localStorage.setItem(STORAGE_KEYS.KAKEIBO, JSON.stringify(kakeiboRecords));
      localStorage.setItem(STORAGE_KEYS.FIXED, JSON.stringify(fixedMonthly));
    }

    function formatYen(num) {
      if (isNaN(num)) return "Â¥0";
      return "Â¥" + num.toLocaleString("ja-JP");
    }

    function getCurrentMonthStr() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      return `${y}-${m}`;
    }

    function getMonthFromDateStr(dateStr) {
      // "YYYY-MM-DD" -> "YYYY-MM"
      if (!dateStr || dateStr.length < 7) return "";
      return dateStr.slice(0, 7);
    }

    // ===== ã‚µãƒãƒªãƒ¼æ›´æ–° =====
    function updateSummary() {
      const monthInput = document.getElementById("monthFilter");
      const targetMonth = monthInput.value || getCurrentMonthStr();

      let incomeTotal = 0;
      let expenseTotal = 0;

      kakeiboRecords.forEach((r) => {
        if (getMonthFromDateStr(r.date) === targetMonth) {
          if (r.type === "income") {
            incomeTotal += r.amount;
          } else {
            expenseTotal += r.amount;
          }
        }
      });

      let fixedTotal = 0;
      fixedMonthly.forEach((f) => {
        fixedTotal += f.amount;
      });

      const balance = incomeTotal - expenseTotal - fixedTotal;

      document.getElementById("summaryIncome").textContent = formatYen(incomeTotal);
      document.getElementById("summaryExpense").textContent = formatYen(expenseTotal);
      document.getElementById("summaryFixed").textContent = formatYen(fixedTotal);
      document.getElementById("summaryBalance").textContent = formatYen(balance);
    }

    // ===== æœˆã”ã¨ã®é›†è¨ˆï¼ˆã‚°ãƒ©ãƒ•ç”¨ï¼‰ =====
    function calcMonthlyAggregates() {
      const monthMap = {}; // { "2025-01": { income, expense } }

      kakeiboRecords.forEach((r) => {
        const month = getMonthFromDateStr(r.date);
        if (!month) return;
        if (!monthMap[month]) {
          monthMap[month] = { income: 0, expense: 0 };
        }
        if (r.type === "income") {
          monthMap[month].income += r.amount;
        } else {
          monthMap[month].expense += r.amount;
        }
      });

      const months = Object.keys(monthMap).sort(); // æ˜‡é †

      // å›ºå®šè²»ã¯æ¯æœˆåŒã˜ã ã‘ã‹ã‹ã‚‹å‰æ
      const fixedTotal = fixedMonthly.reduce((sum, f) => sum + f.amount, 0);

      const labels = [];
      const incomes = [];
      const expenses = [];
      const balances = [];

      months.forEach((m) => {
        const income = monthMap[m].income;
        const expense = monthMap[m].expense;
        const balance = income - expense - fixedTotal;

        labels.push(m);
        incomes.push(income);
        expenses.push(expense);
        balances.push(balance);
      });

      return { labels, incomes, expenses, balances };
    }

    // ===== æœˆã”ã¨ã®æ¨ç§»ã‚°ãƒ©ãƒ•æç”» =====
    function renderMonthlyChart() {
      const ctx = document.getElementById("monthlyTrendChart");
      if (!ctx) return;

      const { labels, incomes, expenses, balances } = calcMonthlyAggregates();

      if (!labels.length) {
        // ãƒ‡ãƒ¼ã‚¿ãŒãªã„ã¨ãã¯ã‚°ãƒ©ãƒ•ã‚’æ¶ˆã—ã¦çµ‚äº†
        if (monthlyChart) {
          monthlyChart.destroy();
          monthlyChart = null;
        }
        return;
      }

      if (monthlyChart) {
        monthlyChart.destroy();
      }

      monthlyChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "åå…¥",
              data: incomes,
              borderColor: "rgba(37, 99, 235, 1)",
              backgroundColor: "rgba(37, 99, 235, 0.15)",
              tension: 0.3,
              fill: false,
            },
            {
              label: "æ”¯å‡º",
              data: expenses,
              borderColor: "rgba(239, 68, 68, 1)",
              backgroundColor: "rgba(239, 68, 68, 0.15)",
              tension: 0.3,
              fill: false,
            },
            {
              label: "æ®‹ã‚Šï¼ˆåå…¥âˆ’æ”¯å‡ºâˆ’å›ºå®šè²»ï¼‰",
              data: balances,
              borderColor: "rgba(16, 185, 129, 1)",
              backgroundColor: "rgba(16, 185, 129, 0.15)",
              tension: 0.3,
              fill: false,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: "index",
            intersect: false,
          },
          plugins: {
            legend: {
              labels: {
                font: {
                  size: 11,
                },
              },
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const value = context.parsed.y || 0;
                  return `${context.dataset.label}: Â¥${value.toLocaleString("ja-JP")}`;
                },
              },
            },
          },
          scales: {
            x: {
              ticks: {
                font: { size: 11 },
              },
            },
            y: {
              beginAtZero: true,
              ticks: {
                callback: function (value) {
                  return "Â¥" + value.toLocaleString("ja-JP");
                },
                font: { size: 10 },
              },
            },
          },
        },
      });
    }

    // ===== å®¶è¨ˆç°¿ãƒ†ãƒ¼ãƒ–ãƒ«æç”» =====
    function renderKakeiboTable() {
      const tbody = document.querySelector("#kakeiboTable tbody");
      tbody.innerHTML = "";

      const monthInput = document.getElementById("monthFilter");
      const targetMonth = monthInput.value || getCurrentMonthStr();

      // é¸æŠã•ã‚ŒãŸæœˆã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã ã‘è¡¨ç¤ºã€æ—¥ä»˜é™é †
      const filtered = kakeiboRecords
        .filter((r) => getMonthFromDateStr(r.date) === targetMonth)
        .sort((a, b) => (a.date < b.date ? 1 : -1));

      if (filtered.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 6;
        td.className = "text-muted";
        td.textContent = "ã“ã®æœˆã®å®¶è¨ˆç°¿ãƒ‡ãƒ¼ã‚¿ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      filtered.forEach((r) => {
        const tr = document.createElement("tr");

        const tdDate = document.createElement("td");
        tdDate.textContent = r.date;

        const tdType = document.createElement("td");
        const chip = document.createElement("span");
        chip.className = "chip " + (r.type === "income" ? "chip-income" : "chip-expense");
        chip.textContent = r.type === "income" ? "åå…¥" : "æ”¯å‡º";
        tdType.appendChild(chip);

        const tdCategory = document.createElement("td");
        tdCategory.textContent = r.category || "æœªåˆ†é¡";

        const tdAmount = document.createElement("td");
        tdAmount.className = "amount";
        tdAmount.textContent = formatYen(r.amount);

        const tdMemo = document.createElement("td");
        tdMemo.textContent = r.memo || "";

        const tdAction = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.className = "btn-danger";
        delBtn.textContent = "å‰Šé™¤";
        delBtn.addEventListener("click", () => {
          // å®Ÿãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‰Šé™¤
          kakeiboRecords = kakeiboRecords.filter((item) => item.id !== r.id);
          saveData();
          renderKakeiboTable();
          updateSummary();
          renderMonthlyChart(); // â˜… ã‚°ãƒ©ãƒ•æ›´æ–°
        });
        tdAction.appendChild(delBtn);

        tr.appendChild(tdDate);
        tr.appendChild(tdType);
        tr.appendChild(tdCategory);
        tr.appendChild(tdAmount);
        tr.appendChild(tdMemo);
        tr.appendChild(tdAction);
        tbody.appendChild(tr);
      });
    }

    // ===== å›ºå®šè²»ãƒ†ãƒ¼ãƒ–ãƒ«æç”» =====
    function renderFixedTable() {
      const tbody = document.querySelector("#fixedTable tbody");
      tbody.innerHTML = "";

      if (fixedMonthly.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.className = "text-muted";
        td.textContent = "å›ºå®šè²»ã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      fixedMonthly.forEach((f) => {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.textContent = f.name;

        const tdCategory = document.createElement("td");
        tdCategory.textContent = f.category || "";

        const tdAmount = document.createElement("td");
        tdAmount.className = "amount";
        tdAmount.textContent = formatYen(f.amount);

        const tdDay = document.createElement("td");
        tdDay.textContent = f.day ? `${f.day}æ—¥` : "-";

        const tdAction = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.className = "btn-danger";
        delBtn.textContent = "å‰Šé™¤";
        delBtn.addEventListener("click", () => {
          fixedMonthly = fixedMonthly.filter((item) => item.id !== f.id);
          saveData();
          renderFixedTable();
          updateSummary();
          renderMonthlyChart(); // â˜… ã‚°ãƒ©ãƒ•æ›´æ–°
        });
        tdAction.appendChild(delBtn);

        tr.appendChild(tdName);
        tr.appendChild(tdCategory);
        tr.appendChild(tdAmount);
        tr.appendChild(tdDay);
        tr.appendChild(tdAction);
        tbody.appendChild(tr);
      });
    }

    // ===== åˆæœŸåŒ– =====
    function init() {
      loadData();

      // æœˆå…¥åŠ› åˆæœŸå€¤ã‚’ä»Šæœˆã«
      const monthInput = document.getElementById("monthFilter");
      monthInput.value = getCurrentMonthStr();
      monthInput.addEventListener("change", () => {
        renderKakeiboTable();
        updateSummary();
        // ã‚°ãƒ©ãƒ•ã¯å…¨æœŸé–“ã®æ¨ç§»ãªã®ã§ã“ã“ã§ã¯ãã®ã¾ã¾
      });

      // å®¶è¨ˆç°¿ã®æ—¥ä»˜ åˆæœŸå€¤ã‚’ä»Šæ—¥ã«
      const dateInput = document.getElementById("kakeiboDate");
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth() + 1).padStart(2, "0");
      const d = String(today.getDate()).padStart(2, "0");
      dateInput.value = `${y}-${m}-${d}`;

      // ãƒ•ã‚©ãƒ¼ãƒ ã‚¤ãƒ™ãƒ³ãƒˆ
      const kakeiboForm = document.getElementById("kakeiboForm");
      kakeiboForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const date = document.getElementById("kakeiboDate").value;
        const type = document.querySelector('input[name="type"]:checked').value;
        const category = document.getElementById("kakeiboCategory").value;
        const amount = Number(document.getElementById("kakeiboAmount").value || 0);
        const memo = document.getElementById("kakeiboMemo").value.trim();

        if (!date || amount <= 0) {
          alert("æ—¥ä»˜ã¨é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          return;
        }

        const newRecord = {
          id: Date.now().toString() + Math.random().toString(16).slice(2),
          date,
          type,
          category,
          amount,
          memo,
        };

        kakeiboRecords.push(newRecord);
        saveData();
        renderKakeiboTable();
        updateSummary();
        renderMonthlyChart(); // â˜… ã‚°ãƒ©ãƒ•æ›´æ–°

        // é‡‘é¡ã ã‘ã‚¯ãƒªã‚¢
        document.getElementById("kakeiboAmount").value = "";
        document.getElementById("kakeiboMemo").value = "";
      });

      const fixedForm = document.getElementById("fixedForm");
      fixedForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const name = document.getElementById("fixedName").value.trim();
        const category = document.getElementById("fixedCategory").value;
        const amount = Number(document.getElementById("fixedAmount").value || 0);
        const day = Number(document.getElementById("fixedDay").value || 0);

        if (!name || amount <= 0) {
          alert("åå‰ã¨é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          return;
        }

        const newItem = {
          id: Date.now().toString() + Math.random().toString(16).slice(2),
          name,
          category,
          amount,
          day: day || null,
        };

        fixedMonthly.push(newItem);
        saveData();
        renderFixedTable();
        updateSummary();
        renderMonthlyChart(); // â˜… ã‚°ãƒ©ãƒ•æ›´æ–°

        document.getElementById("fixedName").value = "";
        document.getElementById("fixedAmount").value = "";
        document.getElementById("fixedDay").value = "";
      });

      // å…¨ãƒªã‚»ãƒƒãƒˆï¼ˆæ³¨æ„ï¼‰
      document.getElementById("resetAllBtn").addEventListener("click", () => {
        if (!confirm("å®¶è¨ˆç°¿ã¨å›ºå®šè²»ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
        kakeiboRecords = [];
        fixedMonthly = [];
        saveData();
        renderKakeiboTable();
        renderFixedTable();
        updateSummary();
        renderMonthlyChart(); // â˜… ã‚°ãƒ©ãƒ•æ›´æ–°
      });

      // åˆå›æç”»
      renderKakeiboTable();
      renderFixedTable();
      updateSummary();
      renderMonthlyChart(); // â˜… åˆå›ã‚°ãƒ©ãƒ•
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
